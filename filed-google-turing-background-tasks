FROM tiangolo/uwsgi-nginx-flask:python3.7 AS build
RUN apt-get update && apt-get install -y --no-install-recommends apt-utils && apt-get install -y unixodbc-dev

FROM build

ARG STAGE
ENV LISTEN_PORT 47551
EXPOSE 47551
ENV PYTHON_SOLUTION_PATH='/app'
ENV PYTHON_ENV=${STAGE}
ENV UWSGI_INI /app/GoogleTuring/BackgroundTasks/uwsgi.ini

# copy source files
COPY ./GoogleTuring/Api /app/GoogleTuring/Api
COPY ./GoogleTuring/BackgroundTasks /app/GoogleTuring/BackgroundTasks
COPY ./GoogleTuring/Infrastructure /app/GoogleTuring/Infrastructure
COPY ./Core /app/Core

# copy requirements and uwsgi files
COPY ./requirements.txt /app/GoogleTuring/BackgroundTasks
COPY ./GoogleTuring/uwsgi.ini /app/GoogleTuring/BackgroundTasks

WORKDIR /app/GoogleTuring/BackgroundTasks
RUN pip install --upgrade pip && pip3 install -r requirements.txt